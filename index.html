<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxanalitica - People Analytics: Gesti贸n de Metas </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ESTILOS PROFESIONALES - HERENCIA DE LA PLATAFORMA */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px;
            position: relative;
        }
        
        /* EFECTO DE FONDO DINMICO */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0 0 L100 100 M100 0 L0 100" stroke="rgba(255,255,255,0.03)" stroke-width="1"/></svg>');
            pointer-events: none;
            z-index: 0;
        }
        
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* HEADER PREMIUM */
        .header-premium {
            background: linear-gradient(135deg, #1e1e2f 0%, #2d2d44 100%);
            padding: 30px 40px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .header-premium::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .logo-text h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #fff, #e0e0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo-text p {
            color: #a0a0c0;
            font-size: 0.9rem;
        }
        
        .header-stats {
            display: flex;
            gap: 25px;
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #a0a0c0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* SISTEMA DE TABS */
        .tabs-system {
            display: flex;
            background: #f8fafd;
            padding: 0 30px;
            gap: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab-btn {
            padding: 18px 30px;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab-btn i {
            font-size: 1.2rem;
        }
        
        .tab-btn:hover {
            color: #3b82f6;
        }
        
        .tab-btn.active {
            color: #3b82f6;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 3px 3px 0 0;
        }
        
        .badge-count {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        /* CONTENEDOR PRINCIPAL */
        .main-content {
            padding: 30px;
            background: #ffffff;
        }
        
        /* REA DE CARGA */
        .upload-area {
            background: linear-gradient(135deg, #f8fafd 0%, #ffffff 100%);
            border: 3px dashed #cbd5e1;
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            margin-bottom: 40px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 20px 30px -10px rgba(59,130,246,0.2);
        }
        
        .upload-icon {
            font-size: 60px;
            color: #3b82f6;
            margin-bottom: 20px;
        }
        
        .upload-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }
        
        .upload-subtitle {
            color: #64748b;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 20px -5px rgba(59,130,246,0.3);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 30px -5px rgba(59,130,246,0.4);
        }
        
        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 12px;
            display: none;
        }
        
        /* SISTEMA DE 3 TABLAS PROFESIONALES */
        .tables-section {
            margin-top: 40px;
        }
        
        .table-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .table-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, #f8fafd, #f1f5f9);
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .table-title h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .table-badge {
            background: #3b82f6;
            color: white;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .table-action-btn {
            padding: 8px 15px;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .table-action-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* ESTILOS DE TABLA PROFESIONALES */
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .excel-table th {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: white;
            font-weight: 600;
            padding: 16px 12px;
            text-align: left;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .excel-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #e9ecef;
            color: #334155;
        }
        
        .excel-table tbody tr:nth-child(even) {
            background-color: #f8fafd;
        }
        
        .excel-table tbody tr:hover {
            background-color: #e6f0ff;
            transition: background-color 0.2s;
        }
        
        /* ESTADOS DE METAS */
        .goal-assigned {
            background-color: #d1fae5;
            color: #065f46;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .goal-missing {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .warning-badge {
            background-color: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* SECCIN DE ANLISIS E INCONSISTENCIAS */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }
        
        .analysis-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .card-header h4 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* KPI CARDS */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .kpi-card-mini {
            background: linear-gradient(135deg, #f8fafd, #ffffff);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            color: #1e293b;
            margin: 10px 0;
        }
        
        .kpi-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        /* LISTA DE INCONSISTENCIAS */
        .inconsistency-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .inconsistency-item {
            padding: 12px;
            border-left: 4px solid;
            margin-bottom: 10px;
            background: #f8fafd;
            border-radius: 8px;
        }
        
        .inconsistency-critical {
            border-left-color: #dc2626;
        }
        
        .inconsistency-warning {
            border-left-color: #f59e0b;
        }
        
        .inconsistency-info {
            border-left-color: #3b82f6;
        }
        
        /* SIMULADOR */
        .simulator-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 30px;
            color: white;
            margin: 40px 0;
        }
        
        .simulator-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        
        .control-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-item label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .control-item input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        /* LOADING */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* BOTONES DE ACCIN */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 10px 20px -5px rgba(59,130,246,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 30px -5px rgba(59,130,246,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-outline {
            background: white;
            border: 2px solid #e9ecef;
            color: #1e293b;
        }
        
        .btn-outline:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        /* FOOTER */
        .footer {
            background: #1e293b;
            color: white;
            padding: 25px 40px;
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* MODAL DE EJEMPLO */
        .modal-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header-content { flex-direction: column; }
            .tabs-system { overflow-x: auto; }
            .excel-table { font-size: 0.8rem; }
            .excel-table th, .excel-table td { padding: 10px 6px; }
        }
    </style>
</head>
<body>
    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 style="margin-bottom: 10px;">Procesando datos...</h3>
            <p style="color: #666;">Analizando estructuras y generando reportes</p>
        </div>
    </div>

    <!-- MODAL DE VISTA PREVIA DE EJEMPLO -->
    <div class="modal-preview" id="previewModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #1e293b;"><i class="fas fa-file-excel" style="color: #3b82f6;"></i> Estructura de Archivos Requerida</h2>
                <button onclick="document.getElementById('previewModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3 style="color: #2563eb; margin-bottom: 15px;"> 1. Excel de Colaboradores (Maestro)</h3>
                <p style="background: #f8fafd; padding: 10px; border-radius: 8px; font-family: monospace;">
                    rut | identifier | username | firstname | lastname | email | position | area_code | area | manager_id_1
                </p>
                <p style="margin-top: 10px; color: #666;"><i class="fas fa-info-circle"></i> Ejemplo: 12.345.678-9 | EMP001 | jperez | Juan | P茅rez | juan@empresa.com | Analista | VENT | Ventas | MGR001</p>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3 style="color: #059669; margin-bottom: 15px;"> 2. Excel de reas (Jerarqu铆a)</h3>
                <p style="background: #f8fafd; padding: 10px; border-radius: 8px; font-family: monospace;">
                    area | area_code | area_parent | area_description
                </p>
                <p style="margin-top: 10px; color: #666;">Ejemplo: Ventas | VENT | DIR | Departamento de Ventas y Comercial</p>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3 style="color: #f59e0b; margin-bottom: 15px;"> 3. Excel de Metas (Asignaciones)</h3>
                <p style="background: #f8fafd; padding: 10px; border-radius: 8px; font-family: monospace;">
                    identifier | group_goal_name | goal_title | ponderation_%
                </p>
                <p style="margin-top: 10px; color: #666;">Ejemplo: EMP001 | Objetivos Comerciales | Incrementar ventas 15% | 30</p>
            </div>
            
            <div style="background: #e6f7ff; padding: 20px; border-radius: 12px;">
                <p><i class="fas fa-lightbulb" style="color: #f59e0b;"></i> <strong>Regla de Oro:</strong> El archivo final mostrar谩 TODOS los colaboradores de la Tabla 1, incluso si no tienen metas asignadas (aparecer谩n como "Sin Meta Asignada").</p>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="downloadExampleFiles()" class="btn btn-success">
                    <i class="fas fa-download"></i> Descargar Archivos de Ejemplo
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- HEADER PREMIUM -->
        <div class="header-premium">
            <div class="header-content">
                <div class="logo-area">
                    <div class="logo-icon">
                        <i class="fas fa-chart-network"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Luxanalitica People Analytics</h1>
                        <p>Sistema Inteligente de Gesti贸n de Metas y Evaluaci贸n 360掳</p>
                    </div>
                </div>
                <div class="header-stats" id="headerStats">
                    <div class="stat-item">
                        <div class="stat-value" id="statEmployees">0</div>
                        <div class="stat-label">Colaboradores</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statAreas">0</div>
                        <div class="stat-label">reas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statGoals">0</div>
                        <div class="stat-label">Metas Asignadas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SISTEMA DE TABS -->
        <div class="tabs-system">
            <button class="tab-btn active" onclick="switchTab('carga')">
                <i class="fas fa-cloud-upload-alt"></i> Carga de Datos
            </button>
            <button class="tab-btn" onclick="switchTab('tablas')">
                <i class="fas fa-table"></i> Visualizaci贸n de Tablas
                <span class="badge-count" id="tabTablesCount">3</span>
            </button>
            <button class="tab-btn" onclick="switchTab('analisis')">
                <i class="fas fa-chart-line"></i> An谩lisis e Inconsistencias
            </button>
            <button class="tab-btn" onclick="switchTab('simulador')">
                <i class="fas fa-sliders-h"></i> Simulador de Metas
            </button>
            <button class="tab-btn" onclick="switchTab('reportes')">
                <i class="fas fa-file-pdf"></i> Reportes
            </button>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-content">
            <!-- SECCIN DE CARGA (TAB 1) -->
            <div id="tab-carga" style="display: block;">
                <!-- REA DE CARGA PRINCIPAL -->
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h2 class="upload-title">隆Bienvenido al Sistema de Gesti贸n de Metas!</h2>
                    <p class="upload-subtitle">
                        Comienza cargando tus archivos Excel. El sistema validar谩 autom谩ticamente la estructura, 
                        detectar谩 inconsistencias y te ayudar谩 a crear un plan de metas perfecto para tu organizaci贸n.
                    </p>
                    <button class="upload-btn">
                        <i class="fas fa-folder-open"></i> Seleccionar Archivos Excel
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple style="display: none;" onchange="handleFileSelect(event)">
                    <div class="file-info" id="fileInfo"></div>
                </div>

                <!-- BOTONES DE ACCIN RPIDA -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadSampleData()">
                        <i class="fas fa-flask"></i> Cargar Datos de Ejemplo
                    </button>
                    <button class="btn btn-outline" onclick="showPreviewModal()">
                        <i class="fas fa-eye"></i> Ver Estructura Requerida
                    </button>
                    <button class="btn btn-success" onclick="downloadExampleFiles()">
                        <i class="fas fa-download"></i> Descargar Plantillas
                    </button>
                </div>

                <!-- GUA RPIDA -->
                <div style="background: linear-gradient(135deg, #f8fafd, #ffffff); padding: 30px; border-radius: 20px; margin-top: 30px;">
                    <h3 style="color: #1e293b; margin-bottom: 20px;"><i class="fas fa-rocket" style="color: #3b82f6;"></i> 驴C贸mo funciona?</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 2rem; color: #3b82f6; margin-bottom: 10px;">1锔</div>
                            <h4 style="margin-bottom: 10px;">Carga tus archivos</h4>
                            <p style="color: #666;">Sube los 3 Excel: Colaboradores, reas y Metas (si ya tienes asignaciones)</p>
                        </div>
                        <div>
                            <div style="font-size: 2rem; color: #3b82f6; margin-bottom: 10px;">2锔</div>
                            <h4 style="margin-bottom: 10px;">Validaci贸n autom谩tica</h4>
                            <p style="color: #666;">El sistema detecta duplicados, 谩reas sin colaboradores y metas inconsistentes</p>
                        </div>
                        <div>
                            <div style="font-size: 2rem; color: #3b82f6; margin-bottom: 10px;">3锔</div>
                            <h4 style="margin-bottom: 10px;">Genera el cruce perfecto</h4>
                            <p style="color: #666;">Creamos la tabla maestro con TODOS los colaboradores y sus metas (o "Sin Meta")</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIN DE TABLAS (TAB 2) -->
            <div id="tab-tablas" style="display: none;">
                <!-- TABLA 1: COLABORADORES -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">
                            <i class="fas fa-users" style="font-size: 1.5rem; color: #3b82f6;"></i>
                            <h3>Excel de Colaboradores (Maestro)</h3>
                            <span class="table-badge" id="colaboradoresCount">0 registros</span>
                        </div>
                        <div class="table-actions">
                            <button class="table-action-btn" onclick="exportTableToExcel('colaboradoresTable', 'Colaboradores')">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto; max-height: 400px;">
                        <table class="excel-table" id="colaboradoresTable">
                            <thead>
                                <tr>
                                    <th>RUT</th>
                                    <th>Identifier</th>
                                    <th>Username</th>
                                    <th>Firstname</th>
                                    <th>Lastname</th>
                                    <th>Email</th>
                                    <th>Position</th>
                                    <th>Area Code</th>
                                    <th>Area</th>
                                    <th>Manager ID</th>
                                </tr>
                            </thead>
                            <tbody id="colaboradoresBody">
                                <tr><td colspan="10" style="text-align: center; padding: 40px;">Carga datos para visualizar</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TABLA 2: REAS -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">
                            <i class="fas fa-sitemap" style="font-size: 1.5rem; color: #10b981;"></i>
                            <h3>Excel de reas (Jerarqu铆a)</h3>
                            <span class="table-badge" id="areasCount">0 registros</span>
                        </div>
                        <div class="table-actions">
                            <button class="table-action-btn" onclick="exportTableToExcel('areasTable', 'Areas')">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto; max-height: 400px;">
                        <table class="excel-table" id="areasTable">
                            <thead>
                                <tr>
                                    <th>Area</th>
                                    <th>Area Code</th>
                                    <th>Area Parent</th>
                                    <th>Area Description</th>
                                </tr>
                            </thead>
                            <tbody id="areasBody">
                                <tr><td colspan="4" style="text-align: center; padding: 40px;">Carga datos para visualizar</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TABLA 3: GRUPO DE METAS (LEFT JOIN) -->
                <div class="table-container" style="border-left: 5px solid #f59e0b;">
                    <div class="table-header">
                        <div class="table-title">
                            <i class="fas fa-tasks" style="font-size: 1.5rem; color: #f59e0b;"></i>
                            <h3>Grupo de Metas (Cruce Completo - TODOS los colaboradores)</h3>
                            <span class="table-badge" id="metasCount">0 registros</span>
                        </div>
                        <div class="table-actions">
                            <button class="table-action-btn" onclick="exportTableToExcel('metasTable', 'Grupo_Metas')">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                            <button class="table-action-btn" onclick="downloadPdfReport()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto; max-height: 500px;">
                        <table class="excel-table" id="metasTable">
                            <thead>
                                <tr>
                                    <th>Identifier</th>
                                    <th>Firstname</th>
                                    <th>Lastname</th>
                                    <th>Area</th>
                                    <th>Group Goal Name</th>
                                    <th>Goal Title</th>
                                    <th>Ponderation %</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="metasBody">
                                <tr><td colspan="8" style="text-align: center; padding: 40px;">Carga datos para visualizar</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECCIN DE ANLISIS (TAB 3) -->
            <div id="tab-analisis" style="display: none;">
                <!-- KPIs RPIDOS -->
                <div class="kpi-grid">
                    <div class="kpi-card-mini">
                        <i class="fas fa-users" style="color: #3b82f6; font-size: 2rem;"></i>
                        <div class="kpi-value" id="kpiTotalEmpleados">0</div>
                        <div class="kpi-label">Total Empleados</div>
                    </div>
                    <div class="kpi-card-mini">
                        <i class="fas fa-check-circle" style="color: #10b981; font-size: 2rem;"></i>
                        <div class="kpi-value" id="kpiConMetas">0</div>
                        <div class="kpi-label">Con Metas Asignadas</div>
                    </div>
                    <div class="kpi-card-mini">
                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 2rem;"></i>
                        <div class="kpi-value" id="kpiSinMetas">0</div>
                        <div class="kpi-label">Sin Metas</div>
                    </div>
                    <div class="kpi-card-mini">
                        <i class="fas fa-copy" style="color: #dc2626; font-size: 2rem;"></i>
                        <div class="kpi-value" id="kpiDuplicados">0</div>
                        <div class="kpi-label">Posibles Duplicados</div>
                    </div>
                </div>

                <!-- ANLISIS DE INCONSISTENCIAS -->
                <div class="analysis-grid">
                    <!-- INCONSISTENCIAS CRTICAS -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4><i class="fas fa-exclamation-circle" style="color: #dc2626;"></i> Inconsistencias Cr铆ticas</h4>
                            <span class="warning-badge" id="criticasCount">0</span>
                        </div>
                        <div class="inconsistency-list" id="inconsistenciasCriticas"></div>
                    </div>

                    <!-- ADVERTENCIAS -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Advertencias</h4>
                            <span class="warning-badge" id="advertenciasCount">0</span>
                        </div>
                        <div class="inconsistency-list" id="inconsistenciasWarning"></div>
                    </div>

                    <!-- RECOMENDACIONES -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4><i class="fas fa-lightbulb" style="color: #3b82f6;"></i> Recomendaciones</h4>
                            <span class="warning-badge" id="recomendacionesCount">0</span>
                        </div>
                        <div class="inconsistency-list" id="recomendaciones"></div>
                    </div>
                </div>

                <!-- ANLISIS POR REA -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">
                            <h3>Distribuci贸n de Metas por rea</h3>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>rea</th>
                                    <th>Total Empleados</th>
                                    <th>Con Metas</th>
                                    <th>Sin Metas</th>
                                    <th>Cobertura</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="areaAnalysisBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECCIN DE SIMULADOR (TAB 4) -->
            <div id="tab-simulador" style="display: none;">
                <div class="simulator-panel">
                    <h2 style="margin-bottom: 10px;"><i class="fas fa-robot"></i> Simulador Inteligente de Metas</h2>
                    <p style="opacity: 0.9; margin-bottom: 30px;">Ajusta los par谩metros para ver c贸mo impactan en la distribuci贸n de metas</p>
                    
                    <div class="simulator-controls">
                        <div class="control-item">
                            <label><i class="fas fa-chart-line"></i> Cobertura de Metas (%)</label>
                            <input type="range" id="simCoverage" min="0" max="100" value="80" oninput="updateSimulation()">
                            <div style="display: flex; justify-content: space-between;">
                                <span>M铆nimo</span>
                                <span><strong id="coverageValue">80%</strong></span>
                                <span>M谩ximo</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <label><i class="fas fa-weight"></i> Peso Promedio por Meta</label>
                            <input type="range" id="simWeight" min="10" max="50" value="25" oninput="updateSimulation()">
                            <div style="display: flex; justify-content: space-between;">
                                <span>10%</span>
                                <span><strong id="weightValue">25%</strong></span>
                                <span>50%</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <label><i class="fas fa-balance-scale"></i> Balance por rea</label>
                            <input type="range" id="simBalance" min="0" max="100" value="50" oninput="updateSimulation()">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Desbalanceado</span>
                                <span><strong id="balanceValue">50%</strong></span>
                                <span>Balanceado</span>
                            </div>
                        </div>
                    </div>

                    <!-- RESULTADOS DE SIMULACIN -->
                    <div style="background: rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; margin-top: 25px;">
                        <h3 style="margin-bottom: 20px;">Proyecci贸n de Asignaci贸n de Metas</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">Empleados con Meta</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="simConMetas">0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">Empleados sin Meta</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="simSinMetas">0</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">Peso Promedio Real</div>
                                <div style="font-size: 2.5rem; font-weight: 700;" id="simPesoReal">25%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REAS PRIORITARIAS -->
                <div class="analysis-card" style="margin-top: 30px;">
                    <div class="card-header">
                        <h4><i class="fas fa-tasks"></i> reas Prioritarias para Asignaci贸n de Metas</h4>
                    </div>
                    <div id="priorityAreas"></div>
                </div>
            </div>

            <!-- SECCIN DE REPORTES (TAB 5) -->
            <div id="tab-reportes" style="display: none;">
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-file-pdf" style="font-size: 5rem; color: #dc2626; margin-bottom: 20px;"></i>
                    <h2 style="margin-bottom: 20px;">Generaci贸n de Reportes Profesionales</h2>
                    <p style="color: #666; max-width: 600px; margin: 0 auto 30px;">
                        Descarga reportes detallados con el an谩lisis completo de metas, inconsistencias y distribuci贸n por 谩rea
                    </p>
                    <div class="action-buttons" style="justify-content: center;">
                        <button class="btn btn-primary" onclick="downloadPdfReport()">
                            <i class="fas fa-file-pdf"></i> Descargar Reporte PDF
                        </button>
                        <button class="btn btn-success" onclick="exportAllTables()">
                            <i class="fas fa-file-excel"></i> Exportar Todo a Excel
                        </button>
                        <button class="btn btn-warning" onclick="downloadErrorReport()">
                            <i class="fas fa-exclamation-triangle"></i> Reporte de Errores
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <p>Luxanalitica People Analytics v2.0 | Procesamiento 100% local en tu navegador</p>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 10px;">Tus datos nunca salen de tu dispositivo - Seguridad y privacidad garantizadas</p>
        </div>
    </div>

    <script>
        // ============================================
        // ESTRUCTURAS DE DATOS GLOBALES
        // ============================================
        let colaboradores = [];
        let areas = [];
        let metas = [];
        let processedGoals = [];

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.getElementById('tab-carga').style.display = 'none';
            document.getElementById('tab-tablas').style.display = 'none';
            document.getElementById('tab-analisis').style.display = 'none';
            document.getElementById('tab-simulador').style.display = 'none';
            document.getElementById('tab-reportes').style.display = 'none';
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Mostrar el tab seleccionado
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            
            // Activar el bot贸n correspondiente
            event.target.classList.add('active');
        }

        function showPreviewModal() {
            document.getElementById('previewModal').style.display = 'flex';
        }

        // ============================================
        // MANEJO DE ARCHIVOS
        // ============================================
        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            showLoading();

            try {
                // Identificar cada archivo por su contenido
                for (let file of files) {
                    const data = await readExcelFile(file);
                    const headers = data[0] || [];
                    
                    // Detectar tipo de archivo por las columnas
                    if (headers.includes('rut') && headers.includes('identifier')) {
                        colaboradores = parseColaboradores(data);
                    } else if (headers.includes('area') && headers.includes('area_code')) {
                        areas = parseAreas(data);
                    } else if (headers.includes('group_goal_name')) {
                        metas = parseMetas(data);
                    }
                }

                // Procesar y mostrar datos
                processAllData();
                updateAllTables();
                updateAnalysis();
                updateHeaderStats();
                
                // Mostrar info de archivos cargados
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfo').innerHTML = `
                    <i class="fas fa-check-circle" style="color: #10b981;"></i> 
                    Archivos cargados: ${files.length} (${colaboradores.length} colaboradores, ${areas.length} 谩reas, ${metas.length} metas)
                `;

                hideLoading();
                
                // Cambiar a la pesta帽a de tablas
                document.querySelectorAll('.tab-btn')[1].click();

            } catch (error) {
                console.error('Error procesando archivos:', error);
                alert('Error al procesar los archivos. Verifica el formato.');
                hideLoading();
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseColaboradores(data) {
            const headers = data[0];
            const rows = data.slice(1).filter(row => row.some(cell => cell));
            
            return rows.map(row => ({
                rut: row[headers.indexOf('rut')] || '',
                identifier: row[headers.indexOf('identifier')] || '',
                username: row[headers.indexOf('username')] || '',
                firstname: row[headers.indexOf('firstname')] || '',
                lastname: row[headers.indexOf('lastname')] || '',
                email: row[headers.indexOf('email')] || '',
                position: row[headers.indexOf('position')] || '',
                area_code: row[headers.indexOf('area_code')] || '',
                area: row[headers.indexOf('area')] || '',
                manager_id: row[headers.indexOf('manager_id_1')] || ''
            }));
        }

        function parseAreas(data) {
            const headers = data[0];
            const rows = data.slice(1).filter(row => row.some(cell => cell));
            
            return rows.map(row => ({
                area: row[headers.indexOf('area')] || '',
                area_code: row[headers.indexOf('area_code')] || '',
                area_parent: row[headers.indexOf('area_parent')] || '',
                area_description: row[headers.indexOf('area_description')] || ''
            }));
        }

        function parseMetas(data) {
            const headers = data[0];
            const rows = data.slice(1).filter(row => row.some(cell => cell));
            
            return rows.map(row => ({
                identifier: row[headers.indexOf('identifier')] || '',
                group_goal_name: row[headers.indexOf('group_goal_name')] || '',
                goal_title: row[headers.indexOf('goal_title')] || '',
                ponderation: parseFloat(row[headers.indexOf('ponderation_%')]) || 0
            }));
        }

        // ============================================
        // PROCESAMIENTO DE DATOS
        // ============================================
        function processAllData() {
            // Crear mapa de 谩reas por c贸digo
            const areaMap = {};
            areas.forEach(a => areaMap[a.area_code] = a.area);
            
            // Crear mapa de metas por identifier
            const metasMap = {};
            metas.forEach(m => {
                if (!metasMap[m.identifier]) {
                    metasMap[m.identifier] = [];
                }
                metasMap[m.identifier].push(m);
            });
            
            // Generar tabla de metas procesada (LEFT JOIN)
            processedGoals = colaboradores.map(col => {
                const metasPersona = metasMap[col.identifier] || [];
                
                if (metasPersona.length > 0) {
                    return metasPersona.map(m => ({
                        identifier: col.identifier,
                        firstname: col.firstname,
                        lastname: col.lastname,
                        area: col.area,
                        group_goal_name: m.group_goal_name,
                        goal_title: m.goal_title,
                        ponderation: m.ponderation,
                        estado: 'Asignada'
                    }));
                } else {
                    // Una fila por colaborador sin metas
                    return [{
                        identifier: col.identifier,
                        firstname: col.firstname,
                        lastname: col.lastname,
                        area: col.area,
                        group_goal_name: 'Sin Meta Asignada',
                        goal_title: 'N/A',
                        ponderation: 0,
                        estado: 'Sin Meta'
                    }];
                }
            }).flat();
        }

        // ============================================
        // ACTUALIZACIN DE TABLAS
        // ============================================
        function updateAllTables() {
            updateColaboradoresTable();
            updateAreasTable();
            updateMetasTable();
        }

        function updateColaboradoresTable() {
            const tbody = document.getElementById('colaboradoresBody');
            document.getElementById('colaboradoresCount').textContent = `${colaboradores.length} registros`;
            
            if (colaboradores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No hay datos cargados</td></tr>';
                return;
            }
            
            tbody.innerHTML = colaboradores.map(col => `
                <tr>
                    <td>${col.rut || '-'}</td>
                    <td><strong>${col.identifier}</strong></td>
                    <td>${col.username}</td>
                    <td>${col.firstname}</td>
                    <td>${col.lastname}</td>
                    <td>${col.email}</td>
                    <td>${col.position}</td>
                    <td>${col.area_code}</td>
                    <td>${col.area}</td>
                    <td>${col.manager_id || '-'}</td>
                </tr>
            `).join('');
        }

        function updateAreasTable() {
            const tbody = document.getElementById('areasBody');
            document.getElementById('areasCount').textContent = `${areas.length} registros`;
            
            if (areas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">No hay datos cargados</td></tr>';
                return;
            }
            
            tbody.innerHTML = areas.map(a => `
                <tr>
                    <td>${a.area}</td>
                    <td><strong>${a.area_code}</strong></td>
                    <td>${a.area_parent || '-'}</td>
                    <td>${a.area_description || '-'}</td>
                </tr>
            `).join('');
        }

        function updateMetasTable() {
            const tbody = document.getElementById('metasBody');
            document.getElementById('metasCount').textContent = `${processedGoals.length} registros`;
            
            if (processedGoals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No hay datos cargados</td></tr>';
                return;
            }
            
            tbody.innerHTML = processedGoals.map(g => `
                <tr>
                    <td><strong>${g.identifier}</strong></td>
                    <td>${g.firstname}</td>
                    <td>${g.lastname}</td>
                    <td>${g.area}</td>
                    <td>
                        <span class="${g.estado === 'Asignada' ? 'goal-assigned' : 'goal-missing'}">
                            ${g.group_goal_name}
                        </span>
                    </td>
                    <td>${g.goal_title}</td>
                    <td>${g.ponderation}%</td>
                    <td>
                        ${g.estado === 'Asignada' 
                            ? '<span class="goal-assigned"><i class="fas fa-check"></i> Asignada</span>' 
                            : '<span class="goal-missing"><i class="fas fa-exclamation"></i> Pendiente</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // ============================================
        // ANLISIS E INCONSISTENCIAS
        // ============================================
        function updateAnalysis() {
            // Calcular KPIs
            const totalEmpleados = colaboradores.length;
            const conMetas = new Set(metas.map(m => m.identifier)).size;
            const sinMetas = totalEmpleados - conMetas;
            
            // Detectar duplicados
            const identifierCount = {};
            colaboradores.forEach(c => {
                identifierCount[c.identifier] = (identifierCount[c.identifier] || 0) + 1;
            });
            const duplicados = Object.values(identifierCount).filter(c => c > 1).length;
            
            // Actualizar KPIs
            document.getElementById('kpiTotalEmpleados').textContent = totalEmpleados;
            document.getElementById('kpiConMetas').textContent = conMetas;
            document.getElementById('kpiSinMetas').textContent = sinMetas;
            document.getElementById('kpiDuplicados').textContent = duplicados;
            
            // Generar inconsistencias
            const criticas = [];
            const warnings = [];
            const recomendaciones = [];
            
            // 1. Colaboradores sin 谩rea asignada
            colaboradores.filter(c => !c.area).forEach(c => {
                criticas.push({
                    type: 'critical',
                    msg: `Colaborador ${c.identifier} (${c.firstname} ${c.lastname}) no tiene 谩rea asignada`
                });
            });
            
            // 2. reas sin colaboradores
            const areasConEmpleados = new Set(colaboradores.map(c => c.area_code).filter(Boolean));
            areas.filter(a => !areasConEmpleados.has(a.area_code)).forEach(a => {
                warnings.push({
                    type: 'warning',
                    msg: `rea ${a.area} (${a.area_code}) no tiene colaboradores asignados`
                });
            });
            
            // 3. Managers que no existen
            const managersExistentes = new Set(colaboradores.map(c => c.identifier));
            colaboradores.filter(c => c.manager_id && !managersExistentes.has(c.manager_id)).forEach(c => {
                warnings.push({
                    type: 'warning',
                    msg: `Colaborador ${c.identifier} tiene manager ${c.manager_id} que no existe en el sistema`
                });
            });
            
            // 4. Metas con ponderaci贸n incorrecta
            metas.filter(m => m.ponderation <= 0 || m.ponderation > 100).forEach(m => {
                warnings.push({
                    type: 'warning',
                    msg: `Meta para ${m.identifier} tiene ponderaci贸n inv谩lida: ${m.ponderation}%`
                });
            });
            
            // 5. Recomendaciones
            if (sinMetas > 0) {
                recomendaciones.push({
                    type: 'info',
                    msg: `Hay ${sinMetas} colaboradores sin metas asignadas. Revisa la tabla de Grupo de Metas.`
                });
            }
            
            if (duplicados > 0) {
                recomendaciones.push({
                    type: 'info',
                    msg: `Se detectaron posibles duplicados en identifiers. Revisa la lista de colaboradores.`
                });
            }
            
            // Actualizar contadores
            document.getElementById('criticasCount').textContent = criticas.length;
            document.getElementById('advertenciasCount').textContent = warnings.length;
            document.getElementById('recomendacionesCount').textContent = recomendaciones.length;
            
            // Renderizar listas
            document.getElementById('inconsistenciasCriticas').innerHTML = criticas.map(c => 
                `<div class="inconsistency-item inconsistency-critical">
                    <i class="fas fa-exclamation-circle" style="color: #dc2626;"></i> ${c.msg}
                </div>`
            ).join('') || '<p style="color: #666; padding: 10px;">No hay inconsistencias cr铆ticas</p>';
            
            document.getElementById('inconsistenciasWarning').innerHTML = warnings.map(w => 
                `<div class="inconsistency-item inconsistency-warning">
                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> ${w.msg}
                </div>`
            ).join('') || '<p style="color: #666; padding: 10px;">No hay advertencias</p>';
            
            document.getElementById('recomendaciones').innerHTML = recomendaciones.map(r => 
                `<div class="inconsistency-item inconsistency-info">
                    <i class="fas fa-lightbulb" style="color: #3b82f6;"></i> ${r.msg}
                </div>`
            ).join('') || '<p style="color: #666; padding: 10px;">No hay recomendaciones</p>';
            
            // An谩lisis por 谩rea
            updateAreaAnalysis();
        }

        function updateAreaAnalysis() {
            const areaStats = {};
            
            colaboradores.forEach(c => {
                if (!areaStats[c.area]) {
                    areaStats[c.area] = { total: 0, conMetas: 0, empleados: [] };
                }
                areaStats[c.area].total++;
                areaStats[c.area].empleados.push(c.identifier);
            });
            
            metas.forEach(m => {
                const col = colaboradores.find(c => c.identifier === m.identifier);
                if (col && areaStats[col.area]) {
                    areaStats[col.area].conMetas++;
                }
            });
            
            const tbody = document.getElementById('areaAnalysisBody');
            tbody.innerHTML = Object.entries(areaStats).map(([area, stats]) => {
                const cobertura = stats.total > 0 ? (stats.conMetas / stats.total * 100).toFixed(1) : 0;
                const estado = cobertura >= 80 ? ' Saludable' : cobertura >= 50 ? '锔 Regular' : ' Cr铆tico';
                
                return `
                    <tr>
                        <td><strong>${area || 'Sin 谩rea'}</strong></td>
                        <td>${stats.total}</td>
                        <td>${stats.conMetas}</td>
                        <td>${stats.total - stats.conMetas}</td>
                        <td>${cobertura}%</td>
                        <td><span class="${cobertura >= 80 ? 'goal-assigned' : 'goal-missing'}">${estado}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateHeaderStats() {
            document.getElementById('statEmployees').textContent = colaboradores.length;
            document.getElementById('statAreas').textContent = areas.length;
            document.getElementById('statGoals').textContent = processedGoals.filter(g => g.estado === 'Asignada').length;
        }

        // ============================================
        // SIMULADOR
        // ============================================
        function updateSimulation() {
            const coverage = parseInt(document.getElementById('simCoverage').value);
            const weight = parseInt(document.getElementById('simWeight').value);
            const balance = parseInt(document.getElementById('simBalance').value);
            
            document.getElementById('coverageValue').textContent = coverage + '%';
            document.getElementById('weightValue').textContent = weight + '%';
            document.getElementById('balanceValue').textContent = balance + '%';
            
            // Calcular proyecci贸n
            const totalEmpleados = colaboradores.length;
            const conMetasSim = Math.round(totalEmpleados * (coverage / 100));
            const sinMetasSim = totalEmpleados - conMetasSim;
            
            document.getElementById('simConMetas').textContent = conMetasSim;
            document.getElementById('simSinMetas').textContent = sinMetasSim;
            document.getElementById('simPesoReal').textContent = weight + '%';
            
            // reas prioritarias
            const areaPriorities = colaboradores.reduce((acc, c) => {
                if (!acc[c.area]) acc[c.area] = 0;
                acc[c.area]++;
                return acc;
            }, {});
            
            const priorityList = Object.entries(areaPriorities)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([area, count]) => `
                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                        <span><strong>${area}</strong></span>
                        <span>${count} empleados</span>
                        <span class="${count > 10 ? 'goal-missing' : 'goal-assigned'}">
                            ${Math.round(count * (coverage / 100))} metas
                        </span>
                    </div>
                `).join('');
            
            document.getElementById('priorityAreas').innerHTML = priorityList || '<p>No hay 谩reas para mostrar</p>';
        }

        // ============================================
        // EXPORTACIONES
        // ============================================
        function exportTableToExcel(tableId, filename) {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportAllTables() {
            exportTableToExcel('colaboradoresTable', 'Colaboradores');
            exportTableToExcel('areasTable', 'Areas');
            exportTableToExcel('metasTable', 'Grupo_Metas');
        }

        async function downloadPdfReport() {
            showLoading();
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape');
                
                pdf.setFontSize(22);
                pdf.setTextColor(30, 41, 59);
                pdf.text('Reporte de Gesti贸n de Metas', 20, 20);
                
                pdf.setFontSize(12);
                pdf.setTextColor(100, 116, 139);
                pdf.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 20, 30);
                
                // Estad铆sticas
                pdf.setFontSize(14);
                pdf.setTextColor(59, 130, 246);
                pdf.text('Resumen Ejecutivo', 20, 45);
                
                pdf.setFontSize(11);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Total Empleados: ${colaboradores.length}`, 20, 55);
                pdf.text(`Con Metas: ${new Set(metas.map(m => m.identifier)).size}`, 20, 62);
                pdf.text(`Sin Metas: ${colaboradores.length - new Set(metas.map(m => m.identifier)).size}`, 20, 69);
                pdf.text(`Total reas: ${areas.length}`, 20, 76);
                
                // Inconsistencias
                pdf.setFontSize(14);
                pdf.setTextColor(220, 38, 38);
                pdf.text('Inconsistencias Detectadas', 20, 95);
                
                let yPos = 105;
                const criticas = document.querySelectorAll('#inconsistenciasCriticas .inconsistency-item');
                criticas.forEach((c, i) => {
                    if (i < 5) {
                        pdf.setFontSize(10);
                        pdf.setTextColor(220, 38, 38);
                        pdf.text(` ${c.textContent}`, 20, yPos);
                        yPos += 7;
                    }
                });
                
                pdf.save(`Reporte_Metas_${new Date().toISOString().slice(0,10)}.pdf`);
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('Error al generar el PDF');
            }
            
            hideLoading();
        }

        function downloadErrorReport() {
            const inconsistencias = [];
            
            document.querySelectorAll('#inconsistenciasCriticas .inconsistency-item, #inconsistenciasWarning .inconsistency-item')
                .forEach(item => inconsistencias.push(item.textContent));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['Reporte de Errores e Inconsistencias'],
                ['Fecha', new Date().toLocaleString('es-ES')],
                [],
                ['Inconsistencias Detectadas:'],
                ...inconsistencias.map(i => [i])
            ]);
            
            XLSX.utils.book_append_sheet(wb, ws, 'Errores');
            XLSX.writeFile(wb, `Errores_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // ============================================
        // DATOS DE EJEMPLO
        // ============================================
        function loadSampleData() {
            showLoading();
            
            // Colaboradores de ejemplo
            colaboradores = [
                { rut: '12.345.678-9', identifier: 'EMP001', username: 'jperez', firstname: 'Juan', lastname: 'P茅rez', email: 'juan@empresa.com', position: 'Analista', area_code: 'VENT', area: 'Ventas', manager_id: 'MGR001' },
                { rut: '23.456.789-0', identifier: 'EMP002', username: 'mgarcia', firstname: 'Mar铆a', lastname: 'Garc铆a', email: 'maria@empresa.com', position: 'Coordinadora', area_code: 'MKT', area: 'Marketing', manager_id: 'MGR002' },
                { rut: '34.567.890-1', identifier: 'EMP003', username: 'crodriguez', firstname: 'Carlos', lastname: 'Rodr铆guez', email: 'carlos@empresa.com', position: 'Desarrollador', area_code: 'IT', area: 'Tecnolog铆a', manager_id: 'MGR003' },
                { rut: '45.678.901-2', identifier: 'EMP004', username: 'amartinez', firstname: 'Ana', lastname: 'Mart铆nez', email: 'ana@empresa.com', position: 'Reclutadora', area_code: 'RH', area: 'Recursos Humanos', manager_id: 'MGR004' },
                { rut: '56.789.012-3', identifier: 'EMP005', username: 'rsanchez', firstname: 'Roberto', lastname: 'S谩nchez', email: 'roberto@empresa.com', position: 'Analista Financiero', area_code: 'FIN', area: 'Finanzas', manager_id: 'MGR005' }
            ];
            
            // reas de ejemplo
            areas = [
                { area: 'Ventas', area_code: 'VENT', area_parent: 'DIR', area_description: 'Departamento de Ventas' },
                { area: 'Marketing', area_code: 'MKT', area_parent: 'DIR', area_description: 'Marketing y Comunicaciones' },
                { area: 'Tecnolog铆a', area_code: 'IT', area_parent: 'DIR', area_description: 'Tecnolog铆a y Sistemas' },
                { area: 'Recursos Humanos', area_code: 'RH', area_parent: 'DIR', area_description: 'Gesti贸n de Personas' },
                { area: 'Finanzas', area_code: 'FIN', area_parent: 'DIR', area_description: 'Finanzas y Contabilidad' }
            ];
            
            // Metas de ejemplo
            metas = [
                { identifier: 'EMP001', group_goal_name: 'Objetivos Comerciales', goal_title: 'Incrementar ventas 15%', ponderation: 30 },
                { identifier: 'EMP001', group_goal_name: 'Objetivos Comerciales', goal_title: 'Retenci贸n de clientes 90%', ponderation: 25 },
                { identifier: 'EMP002', group_goal_name: 'Marketing Digital', goal_title: 'Generar 100 leads', ponderation: 35 },
                { identifier: 'EMP003', group_goal_name: 'Desarrollo', goal_title: 'Completar proyecto Q1', ponderation: 40 },
                { identifier: 'EMP004', group_goal_name: 'Talento', goal_title: 'Cubrir 5 posiciones', ponderation: 30 }
            ];
            
            // Procesar y mostrar
            processAllData();
            updateAllTables();
            updateAnalysis();
            updateHeaderStats();
            updateSimulation();
            
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileInfo').innerHTML = `
                <i class="fas fa-check-circle" style="color: #10b981;"></i> 
                Datos de ejemplo cargados (${colaboradores.length} colaboradores, ${areas.length} 谩reas, ${metas.length} metas)
            `;
            
            hideLoading();
        }

        function downloadExampleFiles() {
            // Colaboradores
            const colsData = [
                ['rut', 'identifier', 'username', 'firstname', 'lastname', 'email', 'position', 'area_code', 'area', 'manager_id_1'],
                ['12.345.678-9', 'EMP001', 'jperez', 'Juan', 'P茅rez', 'juan@empresa.com', 'Analista', 'VENT', 'Ventas', 'MGR001'],
                ['23.456.789-0', 'EMP002', 'mgarcia', 'Mar铆a', 'Garc铆a', 'maria@empresa.com', 'Coordinadora', 'MKT', 'Marketing', 'MGR002']
            ];
            
            const wb = XLSX.utils.book_new();
            const wsCols = XLSX.utils.aoa_to_sheet(colsData);
            XLSX.utils.book_append_sheet(wb, wsCols, 'Colaboradores');
            
            // reas
            const areasData = [
                ['area', 'area_code', 'area_parent', 'area_description'],
                ['Ventas', 'VENT', 'DIR', 'Departamento de Ventas'],
                ['Marketing', 'MKT', 'DIR', 'Marketing y Comunicaciones']
            ];
            const wsAreas = XLSX.utils.aoa_to_sheet(areasData);
            XLSX.utils.book_append_sheet(wb, wsAreas, 'Areas');
            
            // Metas
            const metasData = [
                ['identifier', 'group_goal_name', 'goal_title', 'ponderation_%'],
                ['EMP001', 'Objetivos Comerciales', 'Incrementar ventas 15%', 30],
                ['EMP001', 'Objetivos Comerciales', 'Retenci贸n de clientes 90%', 25]
            ];
            const wsMetas = XLSX.utils.aoa_to_sheet(metasData);
            XLSX.utils.book_append_sheet(wb, wsMetas, 'Metas');
            
            XLSX.writeFile(wb, 'Plantillas_Luxanalitica.xlsx');
        }

        // Inicializar con datos de ejemplo
        window.onload = function() {
            loadSampleData();
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</body>

</html>
